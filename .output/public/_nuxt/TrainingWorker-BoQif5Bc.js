const E=h=>1/(1+Math.exp(-h)),_=h=>Math.max(0,h);function F(h,t){const a=[];for(let e=0;e<13;e++){let o=0;for(let n=0;n<9;n++)o+=t[n]*h.inputWeights[n][e];o+=h.biases[e],a.push(_(o))}const c=[];for(let e=0;e<8;e++){let o=0;for(let n=0;n<13;n++)o+=a[n]*h.outputWeights[n][e];o+=h.biases[13+e],c.push(E(o))}return c}class N{constructor(t,a,c=1){this.vx=0,this.vy=0,this.width=55,this.height=110,this.health=100,this.energy=100,this.state=0,this.direction=1,this.hitbox=null,this.cooldown=0,this.matchFitness=0,this.x=t,this.y=415-this.height,this.genome=a,this.direction=c}update(t){if(this.health<=0){this.y+=this.vy,this.vy+=.8,this.y>375?(this.y=375,this.vx*=.5,this.vy=0):this.x+=this.vx;return}const a=this.processAi(t);if(t.health>0){const n=Math.abs(this.x-t.x);n<400&&(this.matchFitness+=.005),n<200&&(this.matchFitness+=.02),n<80&&(this.matchFitness+=.05);const f=t.x-this.x;(f>0&&this.direction===1||f<0&&this.direction===-1)&&(this.matchFitness+=.02),n<100&&(this.state===5||this.state===6)&&(this.matchFitness+=.1),this.matchFitness-=.005;const s=60;(this.x<s||this.x>800-this.width-s)&&(this.matchFitness-=.04);const x=800/2;Math.abs(this.x+this.width/2-x)<150&&(this.matchFitness+=.015),Math.abs(this.vx)>.5&&(this.matchFitness+=.008)}this.cooldown>0&&this.cooldown--;const e=Math.abs(this.vx)<.5&&this.state===0?.5:.2;this.energy<100&&(this.energy+=e),this.cooldown>15||(a.left&&this.energy>=.5?(this.vx-=1.5,this.energy-=.5,this.direction=-1,this.state=1):a.right&&this.energy>=.5?(this.vx+=1.5,this.energy-=.5,this.direction=1,this.state=2):this.state=0,a.up&&this.y>=415-this.height-1&&this.energy>=12&&(this.vy=-18,this.energy-=12,this.state=3),a.down&&this.y>=415-this.height-1&&this.energy>=.2&&(this.state=4,this.energy-=.2,this.vx*=.5),a.action3&&this.energy>=.5&&(this.state=7,this.energy-=.5,this.vx*=.3)),this.hitbox=null,this.cooldown===0&&(a.action1&&this.energy>10?(this.state=5,this.vx*=.2,this.cooldown=30,this.energy-=10):a.action2&&this.energy>15&&(this.state=6,this.vx*=.2,this.cooldown=20,this.energy-=15)),this.state===5&&this.cooldown<25&&this.cooldown>15?this.hitbox={x:this.direction===1?this.x+this.width:this.x-46,y:this.y+20,w:46,h:20}:this.state===6&&this.cooldown<15&&this.cooldown>5&&(this.hitbox={x:this.direction===1?this.x+this.width:this.x-66,y:this.y+40,w:66,h:30}),this.x+=this.vx,this.y+=this.vy,this.vy+=.8,this.vx*=.85,this.y>415-this.height&&(this.y=415-this.height,this.vy=0,this.state===3&&(this.state=0)),this.x<0&&(this.x=0),this.x>800-this.width&&(this.x=800-this.width)}processAi(t){const a=(t.x-this.x)/800,c=(t.y-this.y)/450,e=this.health/100,o=t.health/100,n=t.state/7,f=this.energy/100,i=this.direction,s=t.cooldown/40,x=t.energy/100,d=[a,c,e,o,n,f,i,s,x],l=F(this.genome.network,d);return{left:l[1]>.5,right:l[2]>.5,up:l[3]>.5,down:l[4]>.5,action1:l[5]>.5,action2:l[6]>.5,action3:l[7]>.5}}checkHit(t){if(this.hitbox&&t.health>0&&this.hitbox.x<t.x+t.width&&this.hitbox.x+this.hitbox.w>t.x&&this.hitbox.y<t.y+t.height&&this.hitbox.y+this.hitbox.h>t.y){const c=this.x>t.x;c&&t.direction===-1||!c&&t.direction;let e=this.state===5?5:10;t.state===7?(e*=.5,t.energy-=5):t.state===4&&(this.state===6?e*=.25:e*=.5,t.energy-=5),t.health=Math.max(0,t.health-e),this.matchFitness+=50,t.matchFitness-=20,t.vx=this.direction*(this.state===6?15:8),t.vy=-5,this.hitbox=null}}}function U(h){const t=h.jobId%2===1,a=t?h.genome2:h.genome1,c=t?h.genome1:h.genome2,e=t?h.spawn2X:h.spawn1X,o=t?h.spawn1X:h.spawn2X,n=Math.max(50,Math.min(350,e)),f=Math.max(400,Math.min(700,o)),i=new N(n,a,1),s=new N(f,c,-1),x=i.health,d=s.health,l=5400;let C=!1;for(let O=0;O<l;O++){if(i.update(s),s.update(i),i.y+i.height>s.y&&s.y+s.height>i.y)if(i.x<s.x){const r=i.x+i.width-s.x;r>0&&(i.x-=r/2,s.x+=r/2)}else{const r=s.x+s.width-i.x;r>0&&(s.x-=r/2,i.x+=r/2)}if(i.checkHit(s),s.checkHit(i),i.health<=0||s.health<=0){C=!0;break}}const D=d-s.health,H=x-i.health,v=D+H;let g=i.matchFitness+i.health*2,y=s.matchFitness+s.health*2;!C&&v<30&&(g-=100,y-=100);let m=t?y:g,u=t?g:y,I=!1,w=!1;return i.health>s.health?t?(u+=500,w=!0):(m+=500,I=!0):s.health>i.health&&(t?(m+=500,I=!0):(u+=500,w=!0)),{jobId:h.jobId,genome1Fitness:m,genome2Fitness:u,genome1Won:I,genome2Won:w,genome1Health:i.health,genome2Health:s.health}}self.onmessage=h=>{const{type:t,jobs:a}=h.data;if(t==="runMatches"&&a){const c=[];for(const e of a){const o=U(e);c.push(o)}self.postMessage({type:"matchResults",results:c})}};self.postMessage({type:"ready"});
